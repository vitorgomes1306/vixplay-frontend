<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração - VixMidia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: none;
            transition: transform 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stats-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white !important;
            opacity: 1 !important;
        }
        .stats-icon i {
            color: #333 !important;
            opacity: 1 !important;
            font-weight: 900 !important;
        }
        
        /* Responsividade para os cards de estatísticas */
        @media (min-width: 1200px) {
            .col-lg-1 {
                flex: 0 0 12%;
                max-width: 12%;
            }
        }
        
        @media (min-width: 992px) and (max-width: 1199px) {
            .col-lg-1 {
                flex: 0 0 14.28%;
                max-width: 14.28%;
            }
        }
        
        .stats-card h5 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .stats-card p.small {
            font-size: 0.8rem;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 1rem 1.5rem;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        .tab-content {
            background: white;
            border-radius: 0 15px 15px 15px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .user-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }
        .user-card.user-blocked {
            opacity: 0.7;
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .badge-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .badge-online {
            background-color: #d4edda;
            color: #155724;
        }
        .badge-offline {
            background-color: #f8d7da;
            color: #721c24;
        }
        .device-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .device-online {
            background-color: #28a745;
        }
        .device-offline {
            background-color: #dc3545;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
        .user-details {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .media-thumbnail {
            transition: transform 0.2s ease;
        }
        
        .media-thumbnail:hover {
            transform: scale(1.05);
        }
        
        .media-thumbnail img {
            border-radius: 4px;
        }
        .detail-tabs .nav-link {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-shield-alt me-2"></i>Administração VixMidia
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link text-white" href="index.html">
                    <i class="fas fa-arrow-left me-1"></i>Voltar ao Dashboard
                </a>
                <a class="nav-link text-white" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Sair
                </a>
            </div>
        </div>
    </nav>

    <!-- Header com Estatísticas -->
    <div class="admin-header">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1 class="mb-4"><i class="fas fa-cogs me-2"></i>Painel de Administração</h1>
                    <div class="row" id="statsContainer">
                        <!-- Estatísticas serão carregadas aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div class="container">
        <div class="row">
            <div class="col-12">
                <!-- Abas -->
                <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>Usuários
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                            <i class="fas fa-cog me-2"></i>Configurações
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button" role="tab">
                            <i class="fas fa-chart-line me-2"></i>Financeiro
                        </button>
                    </li>

                </ul>

                <!-- Conteúdo das Abas -->
                <div class="tab-content" id="adminTabContent">
                    <!-- Aba Usuários -->
                    <div class="tab-pane fade show active" id="users" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3><i class="fas fa-users me-2"></i>Gerenciamento de Usuários do sistema</h3>
                            <div class="input-group" style="width: 300px;">
                                <input type="text" class="form-control" id="searchUsers" placeholder="Buscar usuários...">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="usersContainer" class="loading">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Carregando usuários...</p>
                        </div>
                    </div>

                    <!-- Aba Configurações -->
                    <div class="tab-pane fade" id="settings" role="tabpanel">
                        <h3><i class="fas fa-cog me-2"></i>Configurações do Sistema</h3>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5><i class="fas fa-server me-2"></i>Configurações Gerais</h5>
                            </div>
                            <div class="card-body">
                                <form id="systemConfigForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="valueDevice" class="form-label">Valor do Device</label>
                                                <input type="text" class="form-control" id="valueDevice" placeholder="R$ 30,00">
                                                <div class="form-text">Valor padrão para dispositivos (formato: R$ 00,00)</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="urlWebHookApi" class="form-label">URL WebHook API de Pagamentos</label>
                                                <input type="url" class="form-control" id="urlWebHookApi" placeholder="https://api.exemplo.com/webhook">
                                                <div class="form-text">URL para notificações em tempo real da API de pagamentos</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="urlWebHookSlack" class="form-label">URL WebHook Slack</label>
                                                <input type="url" class="form-control" id="urlWebHookSlack" placeholder="https://hooks.slack.com/services/...">
                                                <div class="form-text">URL do webhook para notificações no Slack</div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="tokenApi" class="form-label">Token API</label>
                                                <input type="text" class="form-control" id="tokenApi" placeholder="Token de autenticação da API" disabled>
                                                <div class="form-text">Token para autenticação nas APIs externas</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="clientId" class="form-label">Client ID</label>
                                                <input type="text" class="form-control" id="clientId" placeholder="ID do cliente">
                                                <div class="form-text">Identificador do cliente para APIs</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                <label for="clientSecret" class="form-label">Client Secret</label>
                                <input type="text" class="form-control" id="clientSecret" placeholder="Chave secreta do cliente">
                                <div class="form-text">Chave secreta para autenticação</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="urlObtainToken" class="form-label">URL Obter Token</label>
                                <input type="text" class="form-control" id="urlObtainToken" placeholder="URL para obtenção de token">
                                <div class="form-text">URL utilizada para obter tokens de autenticação</div>
                            </div>

                             <div class="mb-3">
                                <label for="urlRenewToken" class="form-label">URL Renovação de Token</label>
                                <input type="text" class="form-control" id="urlRenewToken" placeholder="URL para renovar o token">
                                <div class="form-text">URL utilizada para renovar tokens de autenticação</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="urlApi" class="form-label">URL API</label>
                                <input type="text" class="form-control" id="urlApi" placeholder="URL da API">
                                <div class="form-text">URL base da API para requisições</div>
                            </div>
                            
                            <div class="mb-3">
                                                <label for="apiPagamentos" class="form-label">API de Pagamentos</label>
                                                <select class="form-select" id="apiPagamentos">
                                                    <option value="PAGARME">PagarMe</option>
                                                    <option value="PAGSEGURO">PagSeguro</option>
                                                    <option value="LYTEX">Lytex</option>
                                                    <option value="SICOOB">Sicoob</option>
                                                    <option value="INTER">Inter</option>
                                                    <option value="NUBANK">Nubank</option>
                                                    <option value="CORA">Cora</option>
                                                </select>
                                                <div class="form-text">Selecione a API de pagamentos a ser utilizada</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2 mt-4">
                                        <button type="button" class="btn btn-primary" onclick="saveSystemConfig()">
                                            <i class="fas fa-save me-2"></i>Salvar Configurações
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="loadSystemConfig()">
                                            <i class="fas fa-sync me-2"></i>Recarregar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Financeiro -->
                    <div class="tab-pane fade" id="financial" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3><i class="fas fa-chart-line me-2"></i>Relatórios Financeiros</h3>
                            <button class="btn btn-warning" onclick="testBlockOverdueUsers(event)" title="Verificar e bloquear usuários com títulos vencidos há mais de 3 dias">
                                <i class="fas fa-user-lock me-2"></i>Verificar Bloqueios
                            </button>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-dollar-sign fa-3x text-success mb-3"></i>
                                        <h5>Receita Total</h5>
                                        <h3 class="text-success">R$ 0,00</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-credit-card fa-3x text-info mb-3"></i>
                                        <h5>Assinaturas Ativas</h5>
                                        <h3 class="text-info">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-chart-pie fa-3x text-warning mb-3"></i>
                                        <h5>Crescimento Mensal</h5>
                                        <h3 class="text-warning">0%</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Exclusões em Massa -->

                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allUsers = [];
        let currentUser = null;

        // Verificar se o usuário é admin ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
        });

        async function checkAdminAccess() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(buildApiUrl(APP_CONFIG.API_ENDPOINTS.PROFILE), {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    
                    if (!user.isAdmin) {
                        alert('Acesso negado. Apenas administradores podem acessar esta página.');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    // Usuário é admin, carregar dados
                    loadStats();
                    loadUsers();
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Erro ao verificar acesso:', error);
                window.location.href = 'login.html';
            }
        }

        async function loadStats() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(buildApiUrl(APP_CONFIG.API_ENDPOINTS.ADMIN_STATS), {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    displayStats(stats);
                } else {
                    console.error('Erro ao carregar estatísticas:', response.status);
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        function displayStats(stats) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = `
                <div class="col-lg-1 col-md-2 col-sm-3 col-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon mx-auto mb-1" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-users"></i>
                        </div>
                        <h5 class="text-black mb-1">${stats.users.total}</h5>
                        <p class="mb-0 text-black small">Usuários</p>
                        <small class="text-muted text-black" style="font-size: 0.7rem;">${stats.users.active} ativos</small>
                    </div>
                </div>
                <div class="col-lg-1 col-md-2 col-sm-3 col-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon mx-auto mb-1" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="fas fa-tv"></i>
                        </div>
                        <h5 class="text-black mb-1">${stats.panels.total}</h5>
                        <p class="mb-0 text-black small">Painéis</p>
                        <small class="text-muted text-black" style="font-size: 0.7rem;">${stats.panels.active} ativos</small>
                    </div>
                </div>
                <div class="col-lg-1 col-md-2 col-sm-3 col-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon mx-auto mb-1" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <i class="fas fa-desktop"></i>
                        </div>
                        <h5 class="text-black mb-1">${stats.devices.total}</h5>
                        <p class="mb-0 text-black small">Dispositivos</p>
                        <small class="text-muted text-black" style="font-size: 0.7rem;">${stats.devices.online} online</small>
                    </div>
                </div>
                <div class="col-lg-1 col-md-2 col-sm-3 col-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon mx-auto mb-1" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <i class="fas fa-photo-video"></i>
                        </div>
                        <h5 class="text-black mb-1">${stats.medias?.total || 0}</h5>
                        <p class="mb-0 text-black small">Mídias</p>
                        <small class="text-muted text-black" style="font-size: 0.7rem;">arquivos</small>
                    </div>
                </div>
                <div class="col-lg-1 col-md-2 col-sm-3 col-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon mx-auto mb-1" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                            <i class="fas fa-users"></i>
                        </div>
                        <h5 class="text-black mb-1">${stats.clients?.total || 0}</h5>
                        <p class="mb-0 text-black small">Clientes</p>
                        <small class="text-muted text-black" style="font-size: 0.7rem;">cadastrados</small>
                    </div>
                </div>
                <div class="col-lg-1 col-md-2 col-sm-3 col-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon mx-auto mb-1" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                        <h5 class="text-black mb-1">${stats.campaigns.total}</h5>
                        <p class="mb-0 text-black small">Campanhas</p>
                        <small class="text-muted text-black" style="font-size: 0.7rem;">${stats.campaigns.active} ativas</small>
                    </div>
                </div>
                <div class="col-lg-1 col-md-2 col-sm-3 col-6 mb-3">
                    <a href="midias_globais_admin.html" class="text-decoration-none">
                        <div class="stats-card text-center">
                            <div class="stats-icon mx-auto mb-1" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-globe"></i>
                            </div>
                            <h5 class="text-black mb-1">Admin</h5>
                            <p class="mb-0 text-black small">Mídias Globais</p>
                            <small class="text-muted text-black" style="font-size: 0.7rem;">gerenciar</small>
                        </div>
                    </a>
                </div>
            `;
        }

        async function loadUsers() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(buildApiUrl(APP_CONFIG.API_ENDPOINTS.USERS), {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    allUsers = await response.json();
                    displayUsers(allUsers);
                } else {
                    throw new Error('Erro ao carregar usuários');
                }
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                document.getElementById('usersContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erro ao carregar usuários. Tente novamente.
                    </div>
                `;
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5>Nenhum usuário encontrado</h5>
                    </div>
                `;
                return;
            }

            container.innerHTML = users.map(user => `
                <div class="user-card ${user.bloqued ? 'user-blocked' : ''}">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">
                                    ${user.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h5 class="mb-1">${user.name}</h5>
                                    <p class="mb-0 text-muted">${user.email}</p>
                                    <div class="mt-1">
                                        <span class="badge ${user.Active ? 'bg-success' : 'bg-danger'} me-2">
                                            ${user.Active ? 'Ativo' : 'Inativo'}
                                        </span>
                                        ${user.bloqued ? '<span class="badge bg-danger me-2"><i class="fas fa-ban me-1"></i>Bloqueado</span>' : ''}
                                        ${user.isAdmin ? '<span class="badge bg-warning">Admin</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="row text-center">
                                <div class="col-3">
                                    <small class="text-muted">Painéis</small>
                                    <div class="fw-bold">${user.stats.totalPanels}</div>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">Dispositivos</small>
                                    <div class="fw-bold">${user.stats.totalDevices}</div>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">Online</small>
                                    <div class="fw-bold text-success">${user.stats.onlineDevices}</div>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">Mídias</small>
                                    <div class="fw-bold">${user.stats.totalMedias}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="toggleUserDetails(${user.id})">
                                    <i class="fas fa-eye me-1"></i>Detalhes
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="openEditUserModal(${user.id})" title="Editar usuário">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${!user.isAdmin ? `<button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteUser(${user.id}, '${user.name}')" title="Excluir usuário">
                                    <i class="fas fa-trash"></i>
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detalhes do usuário (inicialmente oculto) -->
                    <div id="userDetails${user.id}" class="user-details">
                        <div class="loading text-center">
                            <i class="fas fa-spinner fa-spin"></i> Carregando detalhes...
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function toggleUserDetails(userId) {
            const detailsDiv = document.getElementById(`userDetails${userId}`);
            
            if (detailsDiv.style.display === 'block') {
                detailsDiv.style.display = 'none';
                return;
            }

            detailsDiv.style.display = 'block';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.UPDATE_USER)}/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const userDetails = await response.json();
                    displayUserDetails(userId, userDetails);
                } else {
                    throw new Error('Erro ao carregar detalhes');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do usuário:', error);
                detailsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Erro ao carregar detalhes do usuário.
                    </div>
                `;
            }
        }

        function displayUserDetails(userId, user) {
            const detailsDiv = document.getElementById(`userDetails${userId}`);
            
            detailsDiv.innerHTML = `
                <ul class="nav nav-pills detail-tabs mb-3" id="userDetailTabs${userId}" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="panels-tab-${userId}" data-bs-toggle="pill" data-bs-target="#panels-${userId}" type="button" role="tab">
                            <i class="fas fa-tv me-1"></i>Painéis (${user.panels.length})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="devices-tab-${userId}" data-bs-toggle="pill" data-bs-target="#devices-${userId}" type="button" role="tab">
                            <i class="fas fa-desktop me-1"></i>Dispositivos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="medias-tab-${userId}" data-bs-toggle="pill" data-bs-target="#medias-${userId}" type="button" role="tab">
                            <i class="fas fa-photo-video me-1"></i>Mídias
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="clients-tab-${userId}" data-bs-toggle="pill" data-bs-target="#clients-${userId}" type="button" role="tab">
                            <i class="fas fa-users-cog me-1"></i>Clientes (${user.clients.length})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="financial-tab-${userId}" data-bs-toggle="pill" data-bs-target="#financial-${userId}" type="button" role="tab">
                            <i class="fas fa-dollar-sign me-1"></i>Financeiro
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="userDetailTabContent${userId}">
                    <!-- Painéis -->
                    <div class="tab-pane fade show active" id="panels-${userId}" role="tabpanel">
                        ${user.panels.length > 0 ? user.panels.map(panel => `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <h6 class="mb-0">${panel.name}</h6>
                                            <small class="text-muted">${panel.description || 'Sem descrição'}</small>
                                        </div>
                                        <div class="col-md-3">
                                            <span class="badge ${panel.active ? 'bg-success' : 'bg-secondary'}">
                                                ${panel.active ? 'Ativo' : 'Inativo'}
                                            </span>
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <small class="text-muted">
                                                ${panel.devices.length} dispositivos | ${panel.medias.length} mídias
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<p class="text-muted">Nenhum painel encontrado.</p>'}
                    </div>
                    
                    <!-- Dispositivos -->
                    <div class="tab-pane fade" id="devices-${userId}" role="tabpanel">
                        ${user.panels.flatMap(panel => panel.devices).length > 0 ? user.panels.flatMap(panel => panel.devices).map(device => `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-5">
                                            <div class="d-flex align-items-center">
                                                <span class="device-status ${device.statusDevice ? 'device-online' : 'device-offline'}"></span>
                                                <div>
                                                    <h6 class="mb-0">${device.name}</h6>
                                                    <small class="text-muted">${device.type} - ${device.format}</small>
                                                    <br><small class="text-muted">Licença: <span class="badge ${device.licenceActive ? 'bg-success' : 'bg-warning'}">${device.licenceActive ? 'Ativa' : 'Inativa'}</span></small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <span class="badge-status ${device.statusDevice ? 'badge-online' : 'badge-offline'}">
                                                ${device.statusDevice ? 'Online' : 'Offline'}
                                            </span>
                                        </div>
                                        <div class="col-md-2">
                                            <small class="text-muted">
                                                ${new Date(device.updatedAt).toLocaleDateString('pt-BR')}
                                            </small>
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <button class="btn ${device.licenceActive ? 'btn-warning' : 'btn-success'} btn-sm" 
                                                    onclick="toggleDeviceLicense(${device.id}, ${device.licenceActive})" 
                                                    title="${device.licenceActive ? 'Desativar' : 'Ativar'} licença">
                                                <i class="fas ${device.licenceActive ? 'fa-times' : 'fa-key'} me-1"></i>
                                                ${device.licenceActive ? 'Desativar' : 'Licenciar'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<p class="text-muted">Nenhum dispositivo encontrado.</p>'}
                    </div>
                    
                    <!-- Mídias -->
                    <div class="tab-pane fade" id="medias-${userId}" role="tabpanel">
                        ${user.allMedias && user.allMedias.length > 0 ? user.allMedias.map(media => `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-2">
                                            <div class="media-thumbnail" onclick="openMediaModal('${media.url}', '${media.title || 'Sem título'}', '${media.type}')" style="cursor: pointer;">
                                                ${getMediaThumbnail(media)}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="mb-0">${media.title || 'Sem título'}</h6>
                                            <small class="text-muted">${media.type}</small>
                                            <br><small class="text-info"><i class="fas fa-tv"></i> ${media.panelName || 'Painel não identificado'}</small>
                                            ${media.url ? `<br><small class="text-muted"><i class="fas fa-link"></i> ${media.url.substring(0, 30)}...</small>` : ''}
                                        </div>
                                        <div class="col-md-2">
                                            ${media.duration ? `<small class="text-muted"><i class="fas fa-clock"></i> ${media.duration}s</small>` : ''}
                                        </div>
                                        <div class="col-md-2">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar"></i> ${new Date(media.createdAt).toLocaleDateString('pt-BR')}
                                            </small>
                                        </div>
                                        <div class="col-md-2 text-end">
                                            <button class="btn btn-danger btn-sm" onclick="deleteMedia(${media.id}, '${media.title || 'esta mídia'}')" title="Excluir mídia">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<div class="text-center py-4"><i class="fas fa-photo-video fa-3x text-muted mb-3"></i><p class="text-muted">Nenhuma mídia encontrada.</p></div>'}
                    </div>
                    
                    <!-- Clientes -->
                    <div class="tab-pane fade" id="clients-${userId}" role="tabpanel">
                        ${user.clients.length > 0 ? user.clients.map(client => `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <h6 class="mb-0">${client.name}</h6>
                                            <small class="text-muted">${client.email}</small>
                                        </div>
                                        <div class="col-md-3">
                                            <span class="badge ${client.active ? 'bg-success' : 'bg-secondary'}">
                                                ${client.active ? 'Ativo' : 'Inativo'}
                                            </span>
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <small class="text-muted">
                                                ${client.campaigns.length} campanhas
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<p class="text-muted">Nenhum cliente encontrado.</p>'}
                    </div>
                    
                    <!-- Títulos Financeiros -->
                    <div class="tab-pane fade" id="financial-${userId}" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Títulos Financeiros</h6>
                            <div class="btn-group">
                                <button class="btn btn-primary btn-sm" onclick="openCreateFinancialTitleModal(${userId})">
                                    <i class="fas fa-plus me-1"></i>Novo Título
                                </button>
                                <button class="btn btn-success btn-sm" onclick="openBulkTitlesModal(${userId})">
                                    <i class="fas fa-layer-group me-1"></i>Criar em Massa
                                </button>
                            </div>
                        </div>
                        <div id="financialTitles-${userId}" class="loading-financial">
                            <div class="text-center py-3">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p class="mt-2 text-muted">Carregando títulos financeiros...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Função para gerar miniatura da mídia
        function getMediaThumbnail(media) {
            if (media.type === 'PHOTO') {
                return `<img src="${media.url}" alt="${media.title}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">`;
            } else if (media.type === 'VIDEO') {
                return `<div style="position: relative; width: 60px; height: 60px; border-radius: 4px; overflow: hidden; background: #000;">
                    <video style="width: 100%; height: 100%; object-fit: cover;" muted preload="metadata">
                        <source src="${media.url}#t=0.5" type="video/mp4">
                        <source src="${media.url}#t=0.5" type="video/webm">
                        <source src="${media.url}#t=0.5" type="video/ogg">
                    </video>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-shadow: 0 0 4px rgba(0,0,0,0.8);">
                        <i class="fas fa-play" style="font-size: 1em;"></i>
                    </div>
                </div>`;
            } else if (media.type === 'RSS') {
                return `<div style="width: 60px; height: 60px; background-color: #17a2b8; color: white; border-radius: 4px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-rss" style="font-size: 1.2em;"></i></div>`;
            } else if (media.type === 'WEATHER') {
                return `<div style="width: 60px; height: 60px; background-color: #007bff; color: white; border-radius: 4px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-cloud-sun" style="font-size: 1.2em;"></i></div>`;
            } else {
                return `<div style="width: 60px; height: 60px; background-color: #6c757d; color: white; border-radius: 4px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-file" style="font-size: 1.2em;"></i></div>`;
            }
        }

        // Função para abrir modal de visualização da mídia
        function openMediaModal(url, title, type) {
            const modal = document.getElementById('mediaModal');
            const modalTitle = document.getElementById('mediaModalTitle');
            const modalBody = document.getElementById('mediaModalBody');
            
            modalTitle.textContent = title;
            
            if (type === 'PHOTO') {
                modalBody.innerHTML = `<img src="${url}" alt="${title}" class="img-fluid" style="max-height: 70vh;">`;
            } else if (type === 'VIDEO') {
                modalBody.innerHTML = `<video controls class="w-100" style="max-height: 70vh;"><source src="${url}">Seu navegador não suporta o elemento de vídeo.</video>`;
            } else if (type === 'RSS') {
                modalBody.innerHTML = `<div class="text-center py-4"><i class="fas fa-rss fa-3x text-info mb-3"></i><h5>Feed RSS</h5><p class="text-muted">Esta é uma mídia de feed RSS que exibe conteúdo dinâmico nos painéis.</p><a href="${url}" target="_blank" class="btn btn-info">Ver Feed</a></div>`;
            } else if (type === 'WEATHER') {
                modalBody.innerHTML = `<div class="text-center py-4"><i class="fas fa-cloud-sun fa-3x text-primary mb-3"></i><h5>Widget do Tempo</h5><p class="text-muted">Esta é uma mídia de previsão do tempo que exibe informações meteorológicas nos painéis.</p></div>`;
            } else {
                modalBody.innerHTML = `<div class="text-center py-4"><i class="fas fa-file fa-3x text-muted mb-3"></i><p>Tipo de arquivo não suportado para visualização</p><a href="${url}" target="_blank" class="btn btn-primary">Baixar arquivo</a></div>`;
            }
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        // Função para excluir mídia
        async function deleteMedia(mediaId, mediaTitle) {
            if (!confirm(`Tem certeza que deseja excluir a mídia "${mediaTitle}"?`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.DELETE_MEDIA)}/${mediaId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('Mídia excluída com sucesso!');
                    loadUsers(); // Recarregar a lista de usuários
                } else {
                    throw new Error('Erro ao excluir mídia');
                }
            } catch (error) {
                console.error('Erro ao excluir mídia:', error);
                alert('Erro ao excluir mídia. Tente novamente.');
            }
        }

        // Função de busca de usuários
        document.getElementById('searchUsers').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        });

        // Função para confirmar exclusão de usuário individual
        function confirmDeleteUser(userId, userName) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'deleteUserModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Confirmar Exclusão
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Atenção!</strong> Esta ação não pode ser desfeita.
                            </div>
                            <p>Tem certeza que deseja excluir o usuário <strong>${userName}</strong>?</p>
                            <p class="text-muted">Todos os painéis, dispositivos, mídias e dados relacionados a este usuário também serão excluídos.</p>
                            <div class="mb-3">
                                <label class="form-label">Digite <strong>CONFIRMAR</strong> para prosseguir:</label>
                                <input type="text" class="form-control" id="deleteUserConfirmInput" placeholder="Digite CONFIRMAR">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger" onclick="executeDeleteUser(${userId})" id="confirmDeleteUserBtn" disabled>
                                <i class="fas fa-trash me-1"></i>Excluir Usuário
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Habilitar botão apenas quando "CONFIRMAR" for digitado
            const confirmInput = document.getElementById('deleteUserConfirmInput');
            const confirmBtn = document.getElementById('confirmDeleteUserBtn');
            
            confirmInput.addEventListener('input', function() {
                confirmBtn.disabled = this.value !== 'CONFIRMAR';
            });
            
            // Remover modal do DOM quando fechado
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }
        
        // Função para executar exclusão de usuário
        async function executeDeleteUser(userId) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'));
            modal.hide();
            
            // Mostrar loading
            showDeleteUserLoading();
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.UPDATE_USER)}/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showDeleteUserSuccess();
                    loadUsers(); // Recarregar lista de usuários
                } else {
                    throw new Error('Erro ao excluir usuário');
                }
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                showDeleteUserError();
            }
        }
        
        // Função para mostrar loading durante exclusão
        function showDeleteUserLoading() {
            const alertHtml = `
                <div class="alert alert-info alert-dismissible" id="deleteUserAlert">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <strong>Processando...</strong> Excluindo usuário e todos os dados relacionados.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.querySelector('#users .row');
            container.insertAdjacentHTML('afterbegin', alertHtml);
        }
        
        // Função para mostrar sucesso na exclusão
        function showDeleteUserSuccess() {
            const loadingAlert = document.getElementById('deleteUserAlert');
            if (loadingAlert) loadingAlert.remove();
            
            const alertHtml = `
                <div class="alert alert-success alert-dismissible" id="deleteUserAlert">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Sucesso!</strong> Usuário excluído com sucesso.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.querySelector('#users .row');
            container.insertAdjacentHTML('afterbegin', alertHtml);
            
            // Remover alert após 5 segundos
            setTimeout(() => {
                const alert = document.getElementById('deleteUserAlert');
                if (alert) alert.remove();
            }, 5000);
        }
        
        // Função para mostrar erro na exclusão
        function showDeleteUserError() {
            const loadingAlert = document.getElementById('deleteUserAlert');
            if (loadingAlert) loadingAlert.remove();
            
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible" id="deleteUserAlert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Erro!</strong> Não foi possível excluir o usuário. Tente novamente.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.querySelector('#users .row');
            container.insertAdjacentHTML('afterbegin', alertHtml);
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '../login';
        }

        // Função para abrir modal de edição de usuário
        async function openEditUserModal(userId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.UPDATE_USER)}/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    
                    // Preencher os campos do modal
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editUserName').value = user.name || '';
                    document.getElementById('editUserEmail').value = user.email || '';
                    document.getElementById('editUserCpfCnpj').value = user.cpfCnpj || user.cpfCNPJ || '';
                    document.getElementById('editUserWorkName').value = user.workName || '';
                    document.getElementById('editUserCellphone').value = user.cellphone || '';
                    document.getElementById('editUserPicture').value = user.picture || '';
                    
                    // Dia de vencimento
                    const dayField = document.getElementById('editUserDayOfPayment');
                    if (dayField) {
                        dayField.value = user.dayOfPayment != null ? String(user.dayOfPayment).padStart(2, '0') : '';
                    }
                    
                    // Preencher campos de endereço individuais
                    document.getElementById('editUserZipcode').value = user.zipCode || '';
                    document.getElementById('editUserCity').value = user.city || '';
                    document.getElementById('editUserState').value = user.state || '';
                    document.getElementById('editUserStreet').value = user.street || '';
                    document.getElementById('editUserNumber').value = user.number || '';
                    document.getElementById('editUserComplement').value = user.complement || '';
                    document.getElementById('editUserZone').value = user.zone || '';
                    
                    document.getElementById('editUserPassword').value = '';
                    document.getElementById('editUserActive').checked = user.Active || false;
                    document.getElementById('editUserBlocked').checked = user.bloqued || false;
                    document.getElementById('editUserAdmin').checked = user.isAdmin || false;
                    
                    // Abrir o modal
                    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    modal.show();
                } else {
                    throw new Error('Erro ao carregar dados do usuário');
                }
            } catch (error) {
                console.error('Erro ao abrir modal de edição:', error);
                showEditUserError('Erro ao carregar dados do usuário');
            }
        }

        // Função para salvar alterações do usuário
        async function saveUserChanges() {
            try {
                const userId = document.getElementById('editUserId').value;
                const name = document.getElementById('editUserName').value.trim();
                const email = document.getElementById('editUserEmail').value.trim();
                const cpfCnpj = document.getElementById('editUserCpfCnpj').value.trim();
                const workName = document.getElementById('editUserWorkName').value.trim();
                const cellphone = document.getElementById('editUserCellphone').value.trim();
                const picture = document.getElementById('editUserPicture').value.trim();
                const password = document.getElementById('editUserPassword').value;
                const active = document.getElementById('editUserActive').checked;
                const blocked = document.getElementById('editUserBlocked').checked;
                const isAdmin = document.getElementById('editUserAdmin').checked;
                
                // Dia de vencimento (financeiro)
                const dayOfPaymentRaw = document.getElementById('editUserDayOfPayment')?.value || '';
                const dayOfPayment = dayOfPaymentRaw ? parseInt(dayOfPaymentRaw, 10) : null;
                const allowedDays = ['05','10','15','20','25','30'];
                if (dayOfPaymentRaw && !allowedDays.includes(dayOfPaymentRaw)) {
                    showEditUserError('Selecione um dia de vencimento válido.');
                    return;
                }
                
                // Coletar dados de endereço individuais
                const zipCode = document.getElementById('editUserZipcode').value.trim();
                const city = document.getElementById('editUserCity').value.trim();
                const state = document.getElementById('editUserState').value.trim();
                const street = document.getElementById('editUserStreet').value.trim();
                const number = document.getElementById('editUserNumber').value.trim();
                const complement = document.getElementById('editUserComplement').value.trim();
                const zone = document.getElementById('editUserZone').value.trim();

                // Validações básicas
                if (!name || !email) {
                    showEditUserError('Nome e email são obrigatórios');
                    return;
                }

                // Preparar dados para envio
                const userData = {
                    name,
                    email,
                    cpfCnpj: cpfCnpj || null,
                    workName: workName || null,
                    cellphone: cellphone || null,
                    picture: picture || null,
                    zipCode: zipCode || null,
                    city: city || null,
                    state: state || null,
                    street: street || null,
                    number: number || null,
                    complement: complement || null,
                    zone: zone || null,
                    Active: active,
                    bloqued: blocked,
                    isAdmin,
                    dayOfPayment
                };

                // Incluir senha apenas se foi preenchida
                if (password.trim()) {
                    userData.password = password;
                }

                showEditUserLoading();

                const token = localStorage.getItem('token');
                const response = await fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.UPDATE_USER)}/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    showEditUserSuccess();
                    
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                    modal.hide();
                    
                    // Recarregar lista de usuários
                    setTimeout(() => {
                        loadUsers();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro ao atualizar usuário');
                }
            } catch (error) {
                console.error('Erro ao salvar alterações:', error);
                showEditUserError(error.message);
            }
        }

        // Função para mostrar loading durante edição
        function showEditUserLoading() {
            const alertHtml = `
                <div class="alert alert-info alert-dismissible" id="editUserAlert">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <strong>Processando...</strong> Salvando alterações do usuário.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.querySelector('#users .row');
            container.insertAdjacentHTML('afterbegin', alertHtml);
        }

        // Função para mostrar sucesso na edição
        function showEditUserSuccess() {
            const loadingAlert = document.getElementById('editUserAlert');
            if (loadingAlert) loadingAlert.remove();
            
            const alertHtml = `
                <div class="alert alert-success alert-dismissible" id="editUserAlert">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Sucesso!</strong> Usuário atualizado com sucesso.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.querySelector('#users .row');
            container.insertAdjacentHTML('afterbegin', alertHtml);
            
            // Remover alerta após 3 segundos
            setTimeout(() => {
                const alert = document.getElementById('editUserAlert');
                if (alert) alert.remove();
            }, 3000);
        }

        // Função para mostrar erro na edição
        function showEditUserError(message = 'Erro ao atualizar usuário') {
            const loadingAlert = document.getElementById('editUserAlert');
            if (loadingAlert) loadingAlert.remove();
            
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible" id="editUserAlert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Erro!</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.querySelector('#users .row');
            container.insertAdjacentHTML('afterbegin', alertHtml);
            
            // Remover alerta após 5 segundos
            setTimeout(() => {
                const alert = document.getElementById('editUserAlert');
                if (alert) alert.remove();
            }, 5000);
        }

        // ===== FUNÇÕES DE TÍTULOS FINANCEIROS =====

        // Função para carregar títulos financeiros quando a aba é clicada
        function loadFinancialTitles(userId) {
            const container = document.getElementById(`financialTitles-${userId}`);
            
            // Se já carregou, não carrega novamente
            if (!container.classList.contains('loading-financial')) {
                return;
            }
            
            fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.FINANCIAL_TITLES)}/${userId}/financial-titles`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(titles => {
                container.classList.remove('loading-financial');
                displayFinancialTitles(userId, titles);
            })
            .catch(error => {
                console.error('Erro ao carregar títulos financeiros:', error);
                container.innerHTML = '<div class="text-center py-3 text-danger"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">Erro ao carregar títulos financeiros</p></div>';
            });
        }

        // Função para exibir títulos financeiros
        function displayFinancialTitles(userId, titles) {
            const container = document.getElementById(`financialTitles-${userId}`);
            
            if (titles.length === 0) {
                container.innerHTML = '<div class="text-center py-4"><i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i><p class="text-muted">Nenhum título financeiro encontrado.</p></div>';
                return;
            }
            
            const titlesHtml = titles.map(title => {
                const statusClass = {
                    'PENDING': 'bg-warning',
                    'PAID': 'bg-success',
                    'OVERDUE': 'bg-danger',
                    'CANCELLED': 'bg-secondary'
                }[title.status] || 'bg-secondary';
                
                const statusText = {
                    'PENDING': 'Pendente',
                    'PAID': 'Pago',
                    'OVERDUE': 'Vencido',
                    'CANCELLED': 'Cancelado'
                }[title.status] || 'Desconhecido';
                
                const dueDate = new Date(title.dueDate).toLocaleDateString('pt-BR');
                const createdAt = new Date(title.createdAt).toLocaleDateString('pt-BR');
                
                return `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <h6 class="mb-0">${title.description}</h6>
                                    <small class="text-muted">Criado em ${createdAt}</small>
                                </div>
                                <div class="col-md-2">
                                    <strong class="text-success">R$ ${parseFloat(title.amount).toFixed(2).replace('.', ',')}</strong>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>Venc: ${dueDate}
                                    </small>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge ${statusClass}">${statusText}</span>
                                </div>
                                <div class="col-md-2 text-end">
                                    ${(title.status === 'PENDING' || title.status === 'OVERDUE') ? `
                                        <button class="btn btn-primary btn-sm me-1" onclick="generatePix(${title.id})" title="Gerar PIX">
                                            <i class="fas fa-qrcode"></i>
                                        </button>
                                        <button class="btn btn-success btn-sm me-1" onclick="openManualPaymentSingleModal(${title.id}, ${userId}, '${title.description}', ${title.amount})" title="Baixa Manual">
                                            <i class="fas fa-hand-holding-usd"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="cancelFinancialTitle(${title.id}, ${userId})" title="Cancelar">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : title.pixCode ? `
                                        <button class="btn btn-info btn-sm" onclick="showPix('${title.pixCode}', '${title.pixQrCode}')" title="Ver PIX">
                                            <i class="fas fa-qrcode"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = titlesHtml;
        }

        // Função para abrir modal de criação de título
        function openCreateFinancialTitleModal(userId) {
            document.getElementById('financialTitleUserId').value = userId;
            document.getElementById('createFinancialTitleForm').reset();
            
            // Definir data mínima como hoje
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('financialTitleDueDate').min = today;
            
            const modalElement = document.getElementById('createFinancialTitleModal');
            // Remover aria-hidden antes de mostrar o modal
            modalElement.removeAttribute('aria-hidden');
            
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

        // Função para criar título financeiro
        async function createFinancialTitle() {
            try {
                const userId = document.getElementById('financialTitleUserId').value;
                const description = document.getElementById('financialTitleDescription').value.trim();
                const amount = document.getElementById('financialTitleAmount').value;
                const dueDate = document.getElementById('financialTitleDueDate').value;
                
                if (!description || !amount || !dueDate) {
                    alert('Todos os campos são obrigatórios!');
                    return;
                }
                
                const response = await fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.CREATE_FINANCIAL_TITLE)}/${userId}/financial-titles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        description,
                        amount: parseFloat(amount),
                        dueDate
                    })
                });
                
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createFinancialTitleModal'));
                    modal.hide();
                    
                    // Recarregar títulos financeiros
                    const container = document.getElementById(`financialTitles-${userId}`);
                    container.classList.add('loading-financial');
                    container.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i><p class="mt-2 text-muted">Carregando títulos financeiros...</p></div>';
                    
                    loadFinancialTitles(userId);
                    
                    // Mostrar sucesso
                    alert('Título financeiro criado com sucesso!');
                } else {
                    const error = await response.json();
                    alert('Erro ao criar título: ' + (error.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao criar título financeiro:', error);
                alert('Erro ao criar título financeiro');
            }
        }

        // Função para gerar PIX
        async function generatePix(titleId) {
            try {
                const response = await fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.GENERATE_PIX)}/${titleId}/generate-pix`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showPix(data.pixCode, data.qrCode);
                    
                    // Recarregar a aba financeira do usuário
                    const userId = document.querySelector('[id^="financial-"].active')?.id.split('-')[1];
                    if (userId) {
                        const container = document.getElementById(`financialTitles-${userId}`);
                        container.classList.add('loading-financial');
                        loadFinancialTitles(userId);
                    }
                } else {
                    const error = await response.json();
                    alert('Erro ao gerar PIX: ' + (error.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao gerar PIX:', error);
                alert('Erro ao gerar PIX');
            }
        }

        // Função para mostrar PIX
        function showPix(pixCode, qrCode) {
            document.getElementById('pixCode').value = pixCode;
            document.getElementById('pixQrCode').src = qrCode;
            
            const modal = new bootstrap.Modal(document.getElementById('pixModal'));
            modal.show();
        }

        // Função para copiar código PIX
        function copyPixCode() {
            const pixCodeInput = document.getElementById('pixCode');
            pixCodeInput.select();
            document.execCommand('copy');
            
            // Feedback visual
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Copiado!';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
            }, 2000);
        }

        // Função para cancelar título financeiro
        async function cancelFinancialTitle(titleId, userId) {
            if (!confirm('Tem certeza que deseja cancelar este título financeiro?')) {
                return;
            }
            
            try {
                const response = await fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.DELETE_FINANCIAL_TITLE)}/${titleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    // Recarregar títulos financeiros
                    const container = document.getElementById(`financialTitles-${userId}`);
                    container.classList.add('loading-financial');
                    loadFinancialTitles(userId);
                    
                    alert('Título financeiro cancelado com sucesso!');
                } else {
                    const error = await response.json();
                    alert('Erro ao cancelar título: ' + (error.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao cancelar título:', error);
                alert('Erro ao cancelar título financeiro');
            }
        }

        // Event listener para carregar títulos quando a aba financeiro é clicada
        document.addEventListener('click', function(e) {
            if (e.target.matches('[id^="financial-tab-"]') || e.target.closest('[id^="financial-tab-"]')) {
                const button = e.target.matches('[id^="financial-tab-"]') ? e.target : e.target.closest('[id^="financial-tab-"]');
                const userId = button.id.split('-')[2];
                loadFinancialTitles(userId);
            }
        });

        // Função para abrir modal de criação de títulos em massa
        async function openBulkTitlesModal() {
            try {
                // Carregar lista de clientes
                const response = await fetch(buildApiUrl(APP_CONFIG.API_ENDPOINTS.USERS), {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    const clientSelect = document.getElementById('bulkTitleClient');
                    clientSelect.innerHTML = '<option value="">Selecione um cliente...</option>';
                    
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.name} (${user.email})`;
                        clientSelect.appendChild(option);
                    });
                }
                
                // Definir data mínima como hoje
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('bulkTitleStartDate').min = today;
                document.getElementById('bulkTitleStartDate').value = today;
                
                // Adicionar event listeners para prévia
                ['bulkTitleClient', 'bulkTitleDescription', 'bulkTitleAmount', 'bulkTitleStartDate', 'bulkTitleMonths'].forEach(id => {
                    document.getElementById(id).addEventListener('input', updateBulkTitlesPreview);
                    document.getElementById(id).addEventListener('change', updateBulkTitlesPreview);
                });
                
                const modal = new bootstrap.Modal(document.getElementById('bulkTitlesModal'));
                modal.show();
            } catch (error) {
                console.error('Erro ao abrir modal de títulos em massa:', error);
                alert('Erro ao carregar dados para criação de títulos em massa');
            }
        }

        // Função para atualizar prévia dos títulos em massa
        function updateBulkTitlesPreview() {
            const client = document.getElementById('bulkTitleClient').selectedOptions[0]?.textContent || '';
            const description = document.getElementById('bulkTitleDescription').value;
            const amount = document.getElementById('bulkTitleAmount').value;
            const startDate = document.getElementById('bulkTitleStartDate').value;
            const months = parseInt(document.getElementById('bulkTitleMonths').value) || 0;
            
            const previewContainer = document.getElementById('bulkTitlesPreview');
            
            if (!client || !description || !amount || !startDate || months === 0) {
                previewContainer.innerHTML = '<p class="text-muted mb-0">Preencha os campos acima para ver a prévia dos títulos</p>';
                return;
            }
            
            let previewHtml = `<h6 class="mb-3">Títulos que serão criados para: ${client}</h6>`;
            
            for (let i = 0; i < months; i++) {
                const date = new Date(startDate);
                date.setMonth(date.getMonth() + i);
                const monthYear = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                const dueDate = date.toLocaleDateString('pt-BR');
                
                previewHtml += `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <strong>${description} - ${monthYear.charAt(0).toUpperCase() + monthYear.slice(1)}</strong><br>
                            <small class="text-muted">Vencimento: ${dueDate}</small>
                        </div>
                        <div class="text-success fw-bold">
                            R$ ${parseFloat(amount).toFixed(2).replace('.', ',')}
                        </div>
                    </div>
                `;
            }
            
            previewContainer.innerHTML = previewHtml;
        }

        // Função para criar títulos em massa
        async function createBulkTitles() {
            try {
                const userId = document.getElementById('bulkTitleClient').value;
                const description = document.getElementById('bulkTitleDescription').value.trim();
                const amount = document.getElementById('bulkTitleAmount').value;
                const startDate = document.getElementById('bulkTitleStartDate').value;
                const months = parseInt(document.getElementById('bulkTitleMonths').value);
                
                if (!userId || !description || !amount || !startDate || !months) {
                    alert('Todos os campos são obrigatórios!');
                    return;
                }
                
                const titles = [];
                for (let i = 0; i < months; i++) {
                    const date = new Date(startDate);
                    date.setMonth(date.getMonth() + i);
                    const monthYear = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                    
                    titles.push({
                        description: `${description} - ${monthYear.charAt(0).toUpperCase() + monthYear.slice(1)}`,
                        amount: parseFloat(amount),
                        dueDate: date.toISOString().split('T')[0]
                    });
                }
                
                const response = await fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.BULK_FINANCIAL_TITLES)}/${userId}/financial-titles/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ titles })
                });
                
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('bulkTitlesModal'));
                    modal.hide();
                    
                    alert(`${titles.length} títulos criados com sucesso!`);
                    
                    // Recarregar títulos se a aba do usuário estiver aberta
                    const container = document.getElementById(`financialTitles-${userId}`);
                    if (container) {
                        container.classList.add('loading-financial');
                        container.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i><p class="mt-2 text-muted">Carregando títulos financeiros...</p></div>';
                        loadFinancialTitles(userId);
                    }
                } else {
                    const error = await response.json();
                    alert(`Erro ao criar títulos: ${error.message || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Erro ao criar títulos em massa:', error);
                alert('Erro ao criar títulos em massa');
            }
        }

        // Função para abrir modal de baixa manual


        // Função para abrir modal de baixa manual individual
        function openManualPaymentSingleModal(titleId, userId, titleDescription, titleAmount) {
            document.getElementById('singlePaymentTitleId').value = titleId;
            document.getElementById('singlePaymentUserId').value = userId;
            document.getElementById('singlePaymentTitleInfo').innerHTML = `
                <strong>${titleDescription}</strong><br>
                <span class="text-success fw-bold">R$ ${parseFloat(titleAmount).toFixed(2).replace('.', ',')}</span>
            `;
            
            // Definir data padrão como hoje
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('singlePaymentDate').value = today;
            
            // Resetar formulário
            document.getElementById('singlePaymentMethod').value = '';
            document.getElementById('singlePaymentNotes').value = '';
            
            const modalElement = document.getElementById('singleManualPaymentModal');
            modalElement.removeAttribute('aria-hidden');
            
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // Função para processar baixa manual de um título específico
        async function processManualPaymentSingle() {
            try {
                const titleId = document.getElementById('singlePaymentTitleId').value;
                const userId = document.getElementById('singlePaymentUserId').value;
                const paymentMethod = document.getElementById('singlePaymentMethod').value;
                const paymentDate = document.getElementById('singlePaymentDate').value;
                const paymentNotes = document.getElementById('singlePaymentNotes').value;
                
                if (!paymentMethod || !paymentDate) {
                    alert('Forma de pagamento e data são obrigatórios!');
                    return;
                }
                
                const response = await fetch(`${buildApiUrl(APP_CONFIG.API_ENDPOINTS.MANUAL_PAYMENT)}/${userId}/financial-titles/${titleId}/manual-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        paymentMethod,
                        paymentDate,
                        notes: paymentNotes
                    })
                });
                
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('singleManualPaymentModal'));
                    modal.hide();
                    
                    alert('Baixa realizada com sucesso!');
                    
                    // Recarregar títulos financeiros
                    const container = document.getElementById(`financialTitles-${userId}`);
                    container.classList.add('loading-financial');
                    container.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i><p class="mt-2 text-muted">Carregando títulos financeiros...</p></div>';
                    
                    loadFinancialTitles(userId);
                } else {
                    const error = await response.json();
                    alert(`Erro ao processar pagamento: ${error.message || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Erro ao processar pagamento manual:', error);
                alert('Erro ao processar pagamento manual');
            }
        }

    </script>

    <!-- Modal de Visualização de Mídia -->
    <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mediaModalTitle">Visualizar Mídia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center" id="mediaModalBody">
                    <!-- Conteúdo da mídia será inserido aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição de Usuário -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="editUserModalTitle">
                        <i class="fas fa-edit me-2"></i>
                        Editar Usuário
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUserName" class="form-label">
                                        <i class="fas fa-user me-1"></i>Nome *
                                    </label>
                                    <input type="text" class="form-control" id="editUserName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUserEmail" class="form-label">
                                        <i class="fas fa-envelope me-1"></i>Email *
                                    </label>
                                    <input type="email" class="form-control" id="editUserEmail" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUserCpfCnpj" class="form-label">
                                        <i class="fas fa-id-card me-1"></i>CPF/CNPJ
                                    </label>
                                    <input type="text" class="form-control" id="editUserCpfCnpj">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUserWorkName" class="form-label">
                                        <i class="fas fa-briefcase me-1"></i>Nome Comercial
                                    </label>
                                    <input type="text" class="form-control" id="editUserWorkName">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUserCellphone" class="form-label">
                                        <i class="fas fa-mobile-alt me-1"></i>Celular
                                    </label>
                                    <input type="tel" class="form-control" id="editUserCellphone" placeholder="(00) 00000-0000">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUserPicture" class="form-label">
                                        <i class="fas fa-image me-1"></i>URL da Foto
                                    </label>
                                    <input type="url" class="form-control" id="editUserPicture">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUserDayOfPayment" class="form-label">
                                        <i class="fas fa-calendar-day me-1"></i>Dia de Vencimento
                                    </label>
                                    <select class="form-select" id="editUserDayOfPayment">
                                        <option value="">Selecione...</option>
                                        <option value="05">05</option>
                                        <option value="10">10</option>
                                        <option value="15">15</option>
                                        <option value="20">20</option>
                                        <option value="25">25</option>
                                        <option value="30">30</option>
                                    </select>
                                    <div class="form-text">Usado para gerar cobranças no dia escolhido.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seção de Endereço -->
                        <div class="mb-3">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="fas fa-map-marker-alt me-1"></i>Endereço
                            </h6>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="editUserZipcode" class="form-label">
                                        <i class="fas fa-mail-bulk me-1"></i>CEP
                                    </label>
                                    <input type="text" class="form-control" id="editUserZipcode" placeholder="00000-000" maxlength="9">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editUserCity" class="form-label">
                                        <i class="fas fa-city me-1"></i>Cidade
                                    </label>
                                    <input type="text" class="form-control" id="editUserCity">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="editUserState" class="form-label">
                                        <i class="fas fa-flag me-1"></i>Estado
                                    </label>
                                    <input type="text" class="form-control" id="editUserState" maxlength="2" placeholder="SP" style="text-transform: uppercase;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="editUserZone" class="form-label">
                                        <i class="fas fa-map me-1"></i>Bairro
                                    </label>
                                    <input type="text" class="form-control" id="editUserZone">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUserStreet" class="form-label">
                                        <i class="fas fa-road me-1"></i>Rua
                                    </label>
                                    <input type="text" class="form-control" id="editUserStreet">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="editUserNumber" class="form-label">
                                        <i class="fas fa-hashtag me-1"></i>Número
                                    </label>
                                    <input type="text" class="form-control" id="editUserNumber">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editUserComplement" class="form-label">
                                        <i class="fas fa-plus me-1"></i>Complemento
                                    </label>
                                    <input type="text" class="form-control" id="editUserComplement">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editUserPassword" class="form-label">
                                <i class="fas fa-lock me-1"></i>Nova Senha
                            </label>
                            <input type="password" class="form-control" id="editUserPassword" placeholder="Deixe em branco para manter a senha atual">
                            <div class="form-text">Deixe em branco se não quiser alterar a senha</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editUserActive">
                                    <label class="form-check-label" for="editUserActive">
                                        <i class="fas fa-check-circle me-1"></i>Usuário Ativo
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editUserBlocked">
                                    <label class="form-check-label" for="editUserBlocked">
                                        <i class="fas fa-ban me-1"></i>Usuário Bloqueado
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editUserAdmin">
                                    <label class="form-check-label" for="editUserAdmin">
                                        <i class="fas fa-crown me-1"></i>Administrador
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" onclick="saveUserChanges()">
                        <i class="fas fa-save me-1"></i>Salvar Alterações
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Criar Título Financeiro -->
    <div class="modal fade" id="createFinancialTitleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Criar Título Financeiro
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createFinancialTitleForm">
                        <input type="hidden" id="financialTitleUserId">
                        
                        <div class="mb-3">
                            <label for="financialTitleDescription" class="form-label">
                                <i class="fas fa-file-alt me-1"></i>Descrição
                            </label>
                            <input type="text" class="form-control" id="financialTitleDescription" placeholder="Ex: Mensalidade Janeiro 2024" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="financialTitleAmount" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>Valor (R$)
                                    </label>
                                    <input type="number" class="form-control" id="financialTitleAmount" step="0.01" min="0.01" placeholder="0,00" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="financialTitleDueDate" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Data de Vencimento
                                    </label>
                                    <input type="date" class="form-control" id="financialTitleDueDate" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="createFinancialTitle()">
                        <i class="fas fa-save me-1"></i>Criar Título
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar PIX -->
    <div class="modal fade" id="pixModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-qrcode me-2"></i>Pagamento via PIX
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="pixContent">
                        <div class="mb-4">
                            <h6 class="text-muted">Escaneie o QR Code ou copie o código PIX</h6>
                        </div>
                        
                        <div class="mb-4">
                            <img id="pixQrCode" src="" alt="QR Code PIX" class="img-fluid" style="max-width: 300px;">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Código PIX:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="pixCode" readonly>
                                <button class="btn btn-outline-primary" type="button" onclick="copyPixCode()">
                                    <i class="fas fa-copy"></i> Copiar
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Instruções:</strong><br>
                            1. Abra o app do seu banco<br>
                            2. Escolha a opção PIX<br>
                            3. Escaneie o QR Code ou cole o código PIX<br>
                            4. Confirme o pagamento
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Criar Títulos em Massa -->
    <div class="modal fade" id="bulkTitlesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle me-2"></i>Criar Títulos em Massa
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkTitlesForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bulkTitleClient" class="form-label">
                                        <i class="fas fa-user me-1"></i>Cliente
                                    </label>
                                    <select class="form-select" id="bulkTitleClient" required>
                                        <option value="">Selecione um cliente...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bulkTitleDescription" class="form-label">
                                        <i class="fas fa-file-alt me-1"></i>Descrição Base
                                    </label>
                                    <input type="text" class="form-control" id="bulkTitleDescription" placeholder="Ex: Mensalidade" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="bulkTitleAmount" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>Valor (R$)
                                    </label>
                                    <input type="number" class="form-control" id="bulkTitleAmount" step="0.01" min="0.01" placeholder="0,00" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="bulkTitleStartDate" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Data Inicial
                                    </label>
                                    <input type="date" class="form-control" id="bulkTitleStartDate" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="bulkTitleMonths" class="form-label">
                                        <i class="fas fa-calendar-alt me-1"></i>Quantidade de Meses
                                    </label>
                                    <input type="number" class="form-control" id="bulkTitleMonths" min="1" max="12" value="1" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-preview me-1"></i>Prévia dos Títulos
                            </label>
                            <div id="bulkTitlesPreview" class="border rounded p-3 bg-light">
                                <p class="text-muted mb-0">Preencha os campos acima para ver a prévia dos títulos</p>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="createBulkTitles()">
                        <i class="fas fa-save me-1"></i>Criar Títulos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Baixa Manual Individual -->
    <div class="modal fade" id="singleManualPaymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Baixa Manual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="singlePaymentTitleId">
                    <input type="hidden" id="singlePaymentUserId">
                    
                    <div class="mb-3">
                        <label class="form-label">Título Financeiro:</label>
                        <div id="singlePaymentTitleInfo" class="p-2 bg-light rounded"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="singlePaymentMethod" class="form-label">Forma de Pagamento *</label>
                        <select class="form-select" id="singlePaymentMethod" required>
                            <option value="">Selecione...</option>
                            <option value="CASH">Dinheiro</option>
                            <option value="PIX">PIX</option>
                            <option value="CARD">Cartão</option>
                            <option value="TRANSFER">Transferência</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="singlePaymentDate" class="form-label">Data do Pagamento *</label>
                        <input type="date" class="form-control" id="singlePaymentDate" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="singlePaymentNotes" class="form-label">Observações</label>
                        <textarea class="form-control" id="singlePaymentNotes" rows="3" placeholder="Observações sobre o pagamento (opcional)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="processManualPaymentSingle()">Processar Baixa</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Função para testar bloqueio de usuários com títulos vencidos
        async function testBlockOverdueUsers(event) {
            let button = null;
            try {
                // Mostrar loading no botão
                button = event.target.closest('button');
                const originalContent = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verificando...';
                
                const response = await fetch(buildApiUrl(APP_CONFIG.API_ENDPOINTS.TEST_BLOCK_OVERDUE_USERS), {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Criar modal com os resultados
                    let resultHtml = `
                        <div class="modal fade" id="blockResultModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            <i class="fas fa-user-lock me-2"></i>Resultado da Verificação de Bloqueios
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="alert alert-info">
                                            <h6><i class="fas fa-info-circle me-2"></i>Resumo da Operação</h6>
                                            <p class="mb-1"><strong>Mensagem:</strong> ${data.message}</p>
                                            <p class="mb-1"><strong>Usuários bloqueados:</strong> ${data.blockedUsersCount}</p>
                                            <p class="mb-1"><strong>Títulos vencidos encontrados:</strong> ${data.overdueTitlesCount}</p>
                                            <p class="mb-0"><strong>Total de usuários com títulos vencidos:</strong> ${data.totalUsersWithOverdueTitles}</p>
                                        </div>
                                        
                                        ${data.details && data.details.length > 0 ? `
                                            <h6><i class="fas fa-list me-2"></i>Detalhes dos Usuários</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Nome</th>
                                                            <th>Email</th>
                                                            <th>Status</th>
                                                            <th>Títulos Vencidos</th>
                                                            <th>Vencimento Mais Antigo</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${data.details.map(user => `
                                                            <tr>
                                                                <td>${user.userName}</td>
                                                                <td>${user.userEmail}</td>
                                                                <td>
                                                                    <span class="badge ${user.wasAlreadyBlocked ? 'bg-secondary' : 'bg-warning'}">
                                                                        ${user.wasAlreadyBlocked ? 'Já estava bloqueado' : 'Bloqueado agora'}
                                                                    </span>
                                                                </td>
                                                                <td>${user.overdueTitlesCount}</td>
                                                                <td>${new Date(user.oldestDueDate).toLocaleDateString('pt-BR')}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                                            <i class="fas fa-check me-1"></i>OK
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remover modal anterior se existir
                    const existingModal = document.getElementById('blockResultModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Adicionar novo modal ao DOM
                    document.body.insertAdjacentHTML('beforeend', resultHtml);
                    
                    // Mostrar modal
                    const modal = new bootstrap.Modal(document.getElementById('blockResultModal'));
                    modal.show();
                    
                    // Remover modal do DOM quando fechado
                    document.getElementById('blockResultModal').addEventListener('hidden.bs.modal', function() {
                        this.remove();
                    });
                    
                } else {
                    const error = await response.json();
                    alert('Erro ao executar verificação: ' + (error.error || 'Erro desconhecido'));
                }
                
            } catch (error) {
                console.error('Erro ao testar bloqueio:', error);
                alert('Erro ao executar verificação de bloqueios');
            } finally {
                // Restaurar botão
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-user-lock me-2"></i>Verificar Bloqueios';
                }
            }
        }

        // ===== FUNÇÕES DE FORMATAÇÃO DE MOEDA =====
        
        function formatCurrency(value) {
            // Remove tudo que não é dígito
            const numericValue = value.replace(/\D/g, '');
            
            // Converte para número e divide por 100 para ter centavos
            const floatValue = parseFloat(numericValue) / 100;
            
            // Formata como moeda brasileira
            return floatValue.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            });
        }
        
        function parseCurrencyToFloat(currencyString) {
            // Remove R$, espaços e converte vírgula para ponto
            const numericString = currencyString.replace(/[R$\s]/g, '').replace(',', '.');
            return parseFloat(numericString) || 0;
        }
        
        function parseCurrencyToCents(currencyString) {
            // Converte para float e multiplica por 100 para obter centavos
            return Math.round(parseCurrencyToFloat(currencyString) * 100);
        }
        
        // ===== FUNÇÕES DE CONFIGURAÇÃO DO SISTEMA =====
        
        async function saveSystemConfig() {
            try {
                const configData = {
                    valueDevice: parseCurrencyToCents(document.getElementById('valueDevice').value),
                    urlWebHookApi: document.getElementById('urlWebHookApi').value,
                    urlWebHookSlack: document.getElementById('urlWebHookSlack').value,
                    tokenApi: document.getElementById('tokenApi').value,
                    clientId: document.getElementById('clientId').value,
                    clientSecret: document.getElementById('clientSecret').value,
                    urlObtainToken: document.getElementById('urlObtainToken').value,
                    urlRenewToken: document.getElementById('urlRenewToken').value,
                    urlApi: document.getElementById('urlApi').value,
                    apiPagamentos: document.getElementById('apiPagamentos').value
                };

                const token = localStorage.getItem('token');
                const response = await fetch(`${buildApiUrl('/private/admin/system-config')}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(configData)
                });

                if (response.ok) {
                    alert('Configurações salvas com sucesso!');
                } else {
                    throw new Error('Erro ao salvar configurações');
                }
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                alert('Erro ao salvar configurações');
            }
        }

        async function loadSystemConfig() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${buildApiUrl('/private/admin/system-config')}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const config = await response.json();
                    
                    const deviceValue = config.valueDevice || 3000; // Default 30.00 em centavos
                    document.getElementById('valueDevice').value = formatCurrency((deviceValue / 100).toFixed(2).replace('.', ''));
                    document.getElementById('urlWebHookApi').value = config.urlWebHookApi || '';
                    document.getElementById('urlWebHookSlack').value = config.urlWebHookSlack || '';
                    document.getElementById('tokenApi').value = config.tokenApi || '';
                    document.getElementById('clientId').value = config.clientId || '';
                    document.getElementById('clientSecret').value = config.clientSecret || '';
                    document.getElementById('urlObtainToken').value = config.urlObtainToken || '';
                    document.getElementById('urlRenewToken').value = config.urlRenewToken || '';
                    document.getElementById('urlApi').value = config.urlApi || '';
                    document.getElementById('apiPagamentos').value = config.apiPagamentos || 'PAGARME';
                    
                    console.log('Configurações carregadas com sucesso!');
                } else {
                    console.log('Nenhuma configuração encontrada');
                }
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
                alert('Erro ao carregar configurações');
            }
        }

        // Carregar configurações ao inicializar a aba
        document.getElementById('settings-tab').addEventListener('click', function() {
            loadSystemConfig();
        });
        
        // Função para exibir alertas
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container') || createAlertContainer();
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.maxWidth = '500px';
            
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto-remover após 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Criar container de alertas se não existir
        function createAlertContainer() {
            const container = document.createElement('div');
            container.id = 'alert-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }
        
        // Função para alternar licença do dispositivo
        async function toggleDeviceLicense(deviceId, currentStatus) {
            try {
                const action = currentStatus ? 'desativar' : 'ativar';
                const confirmMessage = `Tem certeza que deseja ${action} a licença deste dispositivo?`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${buildApiUrl('/private/devices')}/${deviceId}/license-toggle`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        licenceActive: !currentStatus
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Mostrar mensagem de sucesso com informações das datas
                    let successMessage = `Licença ${!currentStatus ? 'ativada' : 'desativada'} com sucesso!`;
                    
                    if (!currentStatus && result.device) {
                        // Se ativou a licença, mostrar as datas definidas
                        const expiresAt = result.device.expiresAt ? new Date(result.device.expiresAt).toLocaleDateString('pt-BR') : 'N/A';
                        const lastCheck = result.device.lastLicenseCheck ? new Date(result.device.lastLicenseCheck).toLocaleDateString('pt-BR') : 'N/A';
                        
                        successMessage += `\n\nDatas definidas:\n• Expira em: ${expiresAt}\n• Última verificação: ${lastCheck}`;
                    }
                    
                    showAlert(successMessage, 'success');
                    
                    // Recarregar os detalhes do usuário para atualizar a interface
                    const userDetailsDiv = document.querySelector('[id^="userDetails"][style*="block"]');
                    if (userDetailsDiv) {
                        const userId = userDetailsDiv.id.replace('userDetails', '');
                        toggleUserDetails(userId); // Fechar
                        setTimeout(() => toggleUserDetails(userId), 100); // Reabrir após um delay
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro ao alterar licença');
                }
            } catch (error) {
                console.error('Erro ao alterar licença:', error);
                showAlert(`Erro ao alterar licença: ${error.message}`, 'danger');
            }
        }
        
        // Adicionar formatação em tempo real para o campo valueDevice
        document.getElementById('valueDevice').addEventListener('input', function(e) {
            const cursorPosition = e.target.selectionStart;
            const oldValue = e.target.value;
            const newValue = formatCurrency(e.target.value);
            
            e.target.value = newValue;
            
            // Ajustar posição do cursor
            const lengthDiff = newValue.length - oldValue.length;
            const newCursorPosition = cursorPosition + lengthDiff;
            e.target.setSelectionRange(newCursorPosition, newCursorPosition);
        });
    </script>

</body>
</html>